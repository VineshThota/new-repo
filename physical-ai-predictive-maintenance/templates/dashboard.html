<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical AI Predictive Maintenance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-container {
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card-header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        
        .status-card {
            text-align: center;
            padding: 20px;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .status-online { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-critical { color: #dc3545; }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .alert-item {
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 5px;
        }
        
        .alert-high { border-left-color: #dc3545; }
        .alert-medium { border-left-color: #ffc107; }
        .alert-low { border-left-color: #28a745; }
        
        .equipment-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .btn-ai {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: bold;
        }
        
        .btn-ai:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            color: white;
        }
        
        .maintenance-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        
        .priority-critical { border-left: 4px solid #dc3545; }
        .priority-high { border-left: 4px solid #fd7e14; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot"></i> Physical AI Predictive Maintenance
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white">
                    <i class="fas fa-clock"></i> <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid dashboard-container">
        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="status-icon status-online" id="sensor-status">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <h5>IoT Sensors</h5>
                    <p class="mb-0" id="sensor-count">5 Active</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="status-icon status-online" id="ai-status">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h5>AI Models</h5>
                    <p class="mb-0" id="ai-status-text">Trained</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="status-icon" id="alert-status">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h5>Active Alerts</h5>
                    <p class="mb-0" id="alert-count">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="status-icon status-warning" id="maintenance-status">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h5>Scheduled Maintenance</h5>
                    <p class="mb-0" id="maintenance-count">0</p>
                </div>
            </div>
        </div>

        <!-- Real-time Sensor Data -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Real-time Sensor Monitoring
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="sensorChart"></canvas>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div class="metric-value" id="avg-temp">--</div>
                                    <div class="metric-label">Avg Temp (°C)</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div class="metric-value" id="avg-vibration">--</div>
                                    <div class="metric-label">Avg Vibration</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div class="metric-value" id="avg-pressure">--</div>
                                    <div class="metric-label">Pressure (bar)</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="avg-speed">--</div>
                                    <div class="metric-label">Rotation (RPM)</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="avg-power">--</div>
                                    <div class="metric-label">Power (kW)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-circle"></i> AI Predictions & Alerts
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="predictions-container">
                            <p class="text-muted text-center">No critical predictions at this time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Status Grid -->
        <div class="row mt-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Equipment Status
                    </div>
                    <div class="card-body">
                        <div id="equipment-status-container">
                            <!-- Equipment status will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-alt"></i> Maintenance Schedule
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="maintenance-schedule-container">
                            <p class="text-muted text-center">No scheduled maintenance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anomaly Detection -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-search"></i> Anomaly Detection Results
                        <button class="btn btn-ai btn-sm float-end" onclick="trainModels()">
                            <i class="fas fa-sync-alt"></i> Retrain AI Models
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="anomalies-container">
                            <p class="text-muted text-center">No anomalies detected</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let sensorChart;
        let sensorData = [];
        
        // Initialize dashboard
        $(document).ready(function() {
            initializeChart();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(fetchData, 3000); // Update every 3 seconds
            fetchData(); // Initial load
        });
        
        function updateTime() {
            const now = new Date();
            $('#current-time').text(now.toLocaleString());
        }
        
        function initializeChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Vibration',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Pressure (bar)',
                            data: [],
                            borderColor: 'rgb(255, 205, 86)',
                            backgroundColor: 'rgba(255, 205, 86, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        function fetchData() {
            // Fetch system status
            $.get('/api/system-status', function(data) {
                updateSystemStatus(data);
            });
            
            // Fetch sensor data
            $.get('/api/sensor-data', function(data) {
                updateSensorData(data);
            });
            
            // Fetch predictions
            $.get('/api/predictions', function(data) {
                updatePredictions(data);
            });
            
            // Fetch anomalies
            $.get('/api/anomalies', function(data) {
                updateAnomalies(data);
            });
            
            // Fetch maintenance schedule
            $.get('/api/maintenance-schedule', function(data) {
                updateMaintenanceSchedule(data);
            });
        }
        
        function updateSystemStatus(data) {
            $('#sensor-count').text(data.total_equipment + ' Active');
            $('#ai-status-text').text(data.ai_models_trained ? 'Trained' : 'Training');
            $('#alert-count').text(data.active_alerts);
            $('#maintenance-count').text(data.scheduled_maintenance);
            
            // Update status icons
            $('#sensor-status').removeClass('status-warning status-critical').addClass('status-online');
            $('#ai-status').removeClass('status-warning status-critical').addClass(data.ai_models_trained ? 'status-online' : 'status-warning');
            
            const alertIcon = $('#alert-status');
            alertIcon.removeClass('status-online status-warning status-critical');
            if (data.active_alerts === 0) {
                alertIcon.addClass('status-online');
            } else if (data.active_alerts < 3) {
                alertIcon.addClass('status-warning');
            } else {
                alertIcon.addClass('status-critical');
            }
        }
        
        function updateSensorData(data) {
            if (data.length === 0) return;
            
            // Calculate averages
            const avgTemp = (data.reduce((sum, item) => sum + item.temperature, 0) / data.length).toFixed(1);
            const avgVibration = (data.reduce((sum, item) => sum + item.vibration, 0) / data.length).toFixed(2);
            const avgPressure = (data.reduce((sum, item) => sum + item.pressure, 0) / data.length).toFixed(1);
            const avgSpeed = (data.reduce((sum, item) => sum + item.rotation_speed, 0) / data.length).toFixed(0);
            const avgPower = (data.reduce((sum, item) => sum + item.power_consumption, 0) / data.length).toFixed(1);
            
            $('#avg-temp').text(avgTemp);
            $('#avg-vibration').text(avgVibration);
            $('#avg-pressure').text(avgPressure);
            $('#avg-speed').text(avgSpeed);
            $('#avg-power').text(avgPower);
            
            // Update chart
            const latest = data[data.length - 1];
            const time = new Date(latest.timestamp).toLocaleTimeString();
            
            sensorChart.data.labels.push(time);
            sensorChart.data.datasets[0].data.push(latest.temperature);
            sensorChart.data.datasets[1].data.push(latest.vibration);
            sensorChart.data.datasets[2].data.push(latest.pressure);
            
            // Keep only last 20 data points
            if (sensorChart.data.labels.length > 20) {
                sensorChart.data.labels.shift();
                sensorChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            sensorChart.update('none');
            
            // Update equipment status
            updateEquipmentStatus(data);
        }
        
        function updateEquipmentStatus(data) {
            const equipmentMap = {};
            data.forEach(item => {
                if (!equipmentMap[item.equipment_id]) {
                    equipmentMap[item.equipment_id] = [];
                }
                equipmentMap[item.equipment_id].push(item);
            });
            
            let html = '';
            Object.keys(equipmentMap).forEach(equipmentId => {
                const latest = equipmentMap[equipmentId][equipmentMap[equipmentId].length - 1];
                const status = getEquipmentStatus(latest);
                
                html += `
                    <div class="equipment-status">
                        <div>
                            <strong>${equipmentId}</strong><br>
                            <small class="text-muted">${latest.location}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${status.color}">${status.text}</span><br>
                            <small class="text-muted">${new Date(latest.timestamp).toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
            });
            
            $('#equipment-status-container').html(html);
        }
        
        function getEquipmentStatus(data) {
            // Simple status logic based on sensor values
            if (data.temperature > 100 || data.vibration > 3 || data.pressure > 6) {
                return { color: 'danger', text: 'Critical' };
            } else if (data.temperature > 80 || data.vibration > 2 || data.pressure > 5) {
                return { color: 'warning', text: 'Warning' };
            } else {
                return { color: 'success', text: 'Normal' };
            }
        }
        
        function updatePredictions(data) {
            if (data.length === 0) {
                $('#predictions-container').html('<p class="text-muted text-center">No critical predictions at this time</p>');
                return;
            }
            
            let html = '';
            data.forEach(prediction => {
                const severityClass = prediction.severity.toLowerCase();
                const failureTime = new Date(prediction.predicted_failure_time);
                
                html += `
                    <div class="alert-item alert-${severityClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${prediction.equipment_id}</strong>
                                <span class="badge bg-${severityClass === 'critical' ? 'danger' : 'warning'} ms-2">${prediction.severity}</span>
                                <p class="mb-1 mt-2">${prediction.recommended_action.replace(/_/g, ' ')}</p>
                                <small class="text-muted">Predicted failure: ${failureTime.toLocaleString()}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${(prediction.confidence_score * 100).toFixed(1)}% confidence</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#predictions-container').html(html);
        }
        
        function updateAnomalies(data) {
            if (data.length === 0) {
                $('#anomalies-container').html('<p class="text-muted text-center">No anomalies detected</p>');
                return;
            }
            
            let html = '<div class="row">';
            data.forEach(anomaly => {
                const severityClass = anomaly.severity.toLowerCase();
                const time = new Date(anomaly.timestamp);
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-${severityClass === 'high' ? 'danger' : 'warning'} mb-0">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${anomaly.equipment_id}</strong>
                                    <p class="mb-1">Anomaly detected at ${anomaly.location}</p>
                                    <small>Score: ${anomaly.anomaly_score.toFixed(3)}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${severityClass === 'high' ? 'danger' : 'warning'}">${anomaly.severity}</span><br>
                                    <small>${time.toLocaleTimeString()}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            $('#anomalies-container').html(html);
        }
        
        function updateMaintenanceSchedule(data) {
            if (data.length === 0) {
                $('#maintenance-schedule-container').html('<p class="text-muted text-center">No scheduled maintenance</p>');
                return;
            }
            
            let html = '';
            data.forEach(task => {
                const scheduledTime = new Date(task.scheduled_time);
                const priorityClass = task.priority.toLowerCase();
                
                html += `
                    <div class="maintenance-item priority-${priorityClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${task.equipment_id}</strong>
                                <span class="badge bg-${priorityClass === 'critical' ? 'danger' : priorityClass === 'high' ? 'warning' : 'info'} ms-2">${task.priority}</span>
                                <p class="mb-1 mt-2">Scheduled: ${scheduledTime.toLocaleString()}</p>
                                <small class="text-muted">Duration: ${task.estimated_duration}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#maintenance-schedule-container').html(html);
        }
        
        function trainModels() {
            $.post('/api/train-models', function(data) {
                if (data.status === 'success') {
                    alert('AI models retrained successfully!');
                } else {
                    alert('Failed to retrain models. Please try again.');
                }
            }).fail(function() {
                alert('Error retraining models. Please check the system.');
            });
        }
    </script>
</body>
</html>